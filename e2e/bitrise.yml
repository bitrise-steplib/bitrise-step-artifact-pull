format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  # Shared envs for every test workflow
  - TEST_APP_URL: TODO
  - TEST_APP_BRANCH: TODO
  - BITRISEIO_FINISHED_STAGES: '[{"id":"68df59e4-d108-4bc2-bfb7-a4c1eb402ff8","name":"stage-successful-1","workflows":[{"external_id":"6eea668f-9089-4047-8a66-c9001e88f2dc","finished_at":"2021-11-30T09:37:30Z","id":"a234e4d3-fc0a-4576-8bc9-240c68639f34","name":"successful-20s","started_at":"2021-11-30T09:37:02Z","status":"succeeded"}]},{"id":"59b55e9b-fa65-40ac-9b34-ffcf08f85bd9","name":"stage-successful-2","workflows":[{"external_id":"258d489b-c672-4f63-a508-9e736aacf67d","finished_at":"2021-11-30T09:41:22Z","id":"90896496-e084-4bce-9dbe-8e5ba955ec7a","name":"successful-20s","started_at":"2021-11-30T09:40:54Z","status":"succeeded"},{"external_id":"ea9f95cb-5ed6-42b3-ba14-21342029fd58","finished_at":"2021-11-30T09:44:34Z","id":"8a7ad0a2-b908-461d-a2f4-0ebc31e14974","name":"successful-30s","started_at":"2021-11-30T09:43:58Z","status":"succeeded"}]}]' # yamllint disable-line
  - BITRISE_APP_SLUG: 11abc8954aa46c5a

workflows:

  test_pull_single_artifact_success:
    before_run:
    - _setup
    after_run:
    - _check_downloaded_artifacts
    steps:
      # TODO: should be - path::./ for release (single point)
    - path::../:
        title: Execute step
        inputs:
        - verbose: true
        - artifact_sources: "*"

  # test_pull_artifact_of_different_pipeline_fails:
  #   before_run:
  #   - _setup
  #   after_run:
  #   steps:
  #   - path::./:
  #     title: Execute step
  #     is_skippable: true
  #     inputs:

  _setup:
    steps:
    - script:
        title: Get access token
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex
            bash ./get_access_token.sh
            printenv
    - script:
        title: Clean _tmp folder
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex
            rm -rf ./_tmp            
    - change-workdir:
        title: Switch working dir to _tmp
        run_if: "true"
        inputs:
        - path: ./_tmp
        - is_create_path: true
            
  _check_downloaded_artifacts:
    steps:
    - script:
        title: Validate downloaded artifacts
        is_always_run: true
        inputs:
        - content: |-
            #!/usr/bin/env bash             
            set -ex
            if [ ! -f ./Artifact.zip ]; then
              echo "Artifact.zip not found"
              exit 1
            fi
