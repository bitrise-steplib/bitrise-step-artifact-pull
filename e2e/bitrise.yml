format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  # Shared envs for every test workflow
  - BITRISEIO_FINISHED_STAGES: |-
      [{
        "id": "eda3cd1f-fb5b-4b17-960b-0aed1e5ef9b2",
        "name": "stage-1-new",
        "workflows": [{
          "external_id": "9e3dedb3-3441-40a3-a6ee-b55df86f4112",
          "finished_at": "2022-07-27T21:46:35Z",
          "id": "aa50a889-c364-445a-a47c-e56ae0cb2e01",
          "name": "placeholder",
          "started_at": "2022-07-27T21:46:34Z",
          "status": "succeeded"
        }, {
          "external_id": "cf913e65-a88f-4e81-8625-2bc980af7677",
          "finished_at": "2022-07-27T21:46:48Z",
          "id": "ac069396-fa8f-469d-a86f-be411f8a31d1",
          "name": "textfile_generator-new",
          "started_at": "2022-07-27T21:46:38Z",
          "status": "succeeded"
        }]
      }, {
        "id": "694863de-6075-4431-b0b6-c77b7ca441de",
        "name": "stage-2-new",
        "workflows": [{
          "external_id": "84f9f8ad-09f7-4b0f-84f6-6d7f1f411505",
          "finished_at": "2022-07-27T21:48:08Z",
          "id": "1af16393-b67c-4846-a6e0-40107a178c9a",
          "name": "deployer-new",
          "started_at": "2022-07-27T21:47:35Z",
          "status": "succeeded"
        }, {
          "external_id": "1c98cb3e-a73f-40f1-9a53-5822adee1b5d",
          "finished_at": "2022-07-27T21:47:53Z",
          "id": "908fa7a9-1c5a-462f-9d1b-695747c332ea",
          "name": "textfile_generator-new",
          "started_at": "2022-07-27T21:47:40Z",
          "status": "succeeded"
        }]
      }]
  - BITRISE_APP_SLUG: b520099804d7e71a
  - BITRISE_AUTH_SERVICE_ARTIFACT_PULL_CLIENT_SECRET: $BITRISE_AUTH_SERVICE_ARTIFACT_PULL_CLIENT_SECRET

workflows:

  test_download_all_artifacts_of_build:
    before_run:
    - _setup
    steps:
    - path::./:
        title: Execute step
        inputs:
        - verbose: true
        - artifact_sources: .*
        - bitrise_api_base_url: https://api.bitrise.io
    - script:
        title: Validate downloaded artifacts
        is_always_run: true
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            if [ ! -f $EXAMPLE_CSV ]; then
              echo "EXAMPLE_CSV does not exist"
            fi

            if [ ! -f $EXPORT_OPTIONS_PLIST ]; then
              echo "EXPORT_OPTIONS_PLIST does not exist"
            fi

            if [ ! -f $TEST_JSON ]; then
              echo "TEST_JSON does not exist"
            fi

            if [ ! -f $TEXT_FILE_TXT ]; then
              echo "TEXT_FILE_TXT does not exist"
            fi

  test_download_specific_stage_artifacts:
    before_run:
    - _setup
    steps:
    - path::./:
        title: Execute step
        inputs:
        - verbose: true
        - artifact_sources: stage-1\..*
        - bitrise_api_base_url: https://api.bitrise.io
    - script:
        title: Validate downloaded artifacts
        is_always_run: true
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            if [ ! -f $EXAMPLE_CSV ]; then
              echo "EXAMPLE_CSV does not exist"
            fi

            if [ ! -f $EXPORT_OPTIONS_PLIST ]; then
              echo "EXPORT_OPTIONS_PLIST does not exist"
            fi

            if [ ! -f $TEST_JSON ]; then
              echo "TEST_JSON does not exist"
            fi

  _setup:
    steps:
    - script:
        title: Get access token
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex

            json_response=$(curl --fail -X POST https://auth.services.bitrise.io/auth/realms/bitrise-services/protocol/openid-connect/token -k \
                --data "client_id=artifact-pull" \
                --data "client_secret=$BITRISE_AUTH_SERVICE_ARTIFACT_PULL_CLIENT_SECRET" \
                --data "grant_type=urn:ietf:params:oauth:grant-type:uma-ticket" \
                --data "scope=build_artifact:read build:read app:read" \
                --data "claim_token=ewogICJidWlsZF9pZHMiOiBbCiAgICAiNzBiYmRmZDEtOTZkNS00NDdjLTk3MzEtMjBkYTkzMTI2NDNjIiwKICAgICIzZGFhM2Q5Mi02ZDdhLTQ3OTEtOTI4YS1iODM1MDY4ODFlY2QiLAogICAgIjJmMDMxYzYzLWVkNmMtNGEyNi1hZmYxLTU3YjAwZWQyZjhiYSIsCiAgICAiYTlkNjE0OGUtNTllMS00MTdlLTk5YTAtNDllNWRkMDE0Zjg1IgogIF0sCiAgInBpcGVsaW5lX2lkIjogWwogICAgImIzY2U4MGJhLTEzOGMtNDk4Mi1iMmRmLWM4NGIzMzhiM2EyZSIKICBdCn0=" \
                --data "claim_token_format=urn:ietf:params:oauth:token-type:jwt" \
                --data "audience=bitrise-api")

            auth_token=$(echo $json_response | jq -r .access_token)

            envman add --key BITRISEIO_ARTIFACT_PULL_TOKEN --value $auth_token

    - script:
        title: Clean _tmp folder
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex
            rm -rf ./_artifact_pull
